#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
@TIME: 2020/1/13 17:04
@FILE: feature_hasher.py
@AUTHOR: HU
"""
import pandas as pd
import numpy as np
import os
from pefeatures import PEFeatureExtractor
import multiprocessing
from functools import partial

"""
D:/data/black/
"""

def make_feature(name, feature_extractor):
    file = open("/home/AlphaPlatform/etl/dll/data/" + name, "rb")
    bytez = file.read()
    pe_feature = []
    try:
        pe_feature = feature_extractor.extract(bytez).tolist()
        pe_feature.insert(0, name)
    except:
        pass
    print("/home/AlphaPlatform/etl/dll/data/" + name)
    return pe_feature


if __name__ == '__main__':
    p = multiprocessing.Pool(10)
    files = os.listdir("/home/AlphaPlatform/etl/dll/data/")
    items = [x for x in files if ".dat.1" not in x]
    feature_extractor = PEFeatureExtractor()
    func = partial(make_feature, feature_extractor=feature_extractor)
    list1 = p.map(func, items)
    df = pd.DataFrame(list1)
    df.dropna(inplace=True)
    df.to_csv("dll.csv", index=False)
